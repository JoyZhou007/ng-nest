<div class="x-table-inner" [class.x-table-has-group]="groupQuery.group">
  <div class="x-table-group" *ngIf="groupQuery.group">
    <x-table
      [columns]="groupColumns"
      [query]="groupQuery"
      [service]="service"
      header-hidden
      footer-hidden
      allow-select-row
      first-row-selected
      [row-primary]="groupQuery.group"
      [activated-row]="groupActivatedRow"
      [search-placeholder]="groupSearchPlaceholder"
      (rowClick)="groupRowClick($event)"
    ></x-table>
  </div>
  <div class="x-table-struct">
    <div class="x-table-tool">
      <div class="x-table-tool-left" *ngIf="topLeftActions.length > 0">
        <ng-container *ngTemplateOutlet="buttonsTpl; context: { space: 1, actions: topLeftActions }"></ng-container>
      </div>
      <div class="x-table-tool-right">
        <x-input
          icon="fto-search"
          iconLayout="left"
          [placeholder]="searchPlaceholder"
          [(ngModel)]="searchInput"
          (ngModelChange)="searchChange($event)"
          clearable
        ></x-input>
        <ng-container *ngIf="topRightIconActions.length > 0">
          <ng-container *ngTemplateOutlet="buttonsTpl; context: { actions: topRightIconActions }"></ng-container>
        </ng-container>
      </div>
    </div>
    <div #header class="x-table-header" *ngIf="!headerHidden" [style.height.px]="itemSize">
      <ul
        #headerRow
        class="x-table-row"
        [style.height.px]="itemSize"
        [style.padding-right.px]="scrollYWidth"
        [style.width.px]="scrollXWidth"
      >
        <li
          *ngFor="let column of columns"
          [class.x-table-sticky]="getSticky(column)"
          [style.width.px]="column.width"
          [style.left.px]="column.left"
          [style.flex]="column.width ? 'none' : column.flex"
        >
          <ng-container [ngSwitch]="column.type">
            <ng-container *ngSwitchCase="'index'">
              <span>{{ column.label }}</span>
            </ng-container>
            <ng-container *ngSwitchDefault>
              <a [class.x-table-header-sort]="column.sort" (click)="onSort(column)">
                <ng-container *xOutlet="headerColumnTpl[column.id]; context: { $column: column }">
                  {{ column.label }}
                </ng-container>
                <x-icon
                  class="x-table-header-sort-icon"
                  *ngIf="column.sort"
                  [class.x-table-icon-up]="sortStr === column.id + ' desc'"
                  [class.x-table-icon-down]="sortStr === column.id + ' asc'"
                  type="fto-bar-chart"
                ></x-icon>
              </a>
            </ng-container>
          </ng-container>
        </li>
      </ul>
    </div>
    <div class="x-table-body">
      <cdk-virtual-scroll-viewport
        #virtualBody
        *ngIf="virtualScroll; else bodyTpl"
        class="x-table-virtual-body"
        [itemSize]="itemSize"
        [minBufferPx]="minBufferPx"
        [maxBufferPx]="maxBufferPx"
        [style.height.px]="bodyHeight"
      >
        <ul
          *cdkVirtualFor="let item of tableData; index as i"
          class="x-table-row"
          [class.x-table-row-activated]="allowSelectRow && activatedRow && activatedRow[rowPrimary] === item[rowPrimary]"
          [style.height.px]="itemSize"
          (click)="rowEmit(item, $event)"
        >
          <ng-container *ngTemplateOutlet="bodyRows; context: { item: item, i: i }"></ng-container>
        </ul>
      </cdk-virtual-scroll-viewport>
    </div>
    <div class="x-table-footer" *ngIf="!footerHidden">
      <x-pagination [index]="index" [size]="size" [total]="total" (indexChange)="change($event)"></x-pagination>
    </div>
  </div>
</div>

<ng-template #bodyTpl>
  <ul
    *ngFor="let item of tableData; index as i"
    class="x-table-row"
    [class.x-table-row-activated]="allowSelectRow && activatedRow && activatedRow[rowPrimary] === item[rowPrimary]"
    [style.height.px]="itemSize"
    (click)="rowEmit(item, $event)"
  >
    <ng-container *ngTemplateOutlet="bodyRows; context: { item: item, i: i }"></ng-container>
  </ul>
</ng-template>

<ng-template #bodyRows let-item="item" let-i="i">
  <ng-container *ngFor="let column of columns; index as j">
    <li
      [style.width.px]="column.width"
      [style.flex]="column.width ? 'none' : column.flex"
      [title]="item[column.id] ? item[column.id] : ''"
      [class.x-table-sticky]="getSticky(column)"
      [style.left.px]="column.left"
    >
      <ng-container [ngSwitch]="column.type">
        <ng-container *ngSwitchCase="'index'">
          <div>{{ getIndex(i) }}</div>
        </ng-container>
        <ng-container *ngSwitchDefault>
          <ng-container *xOutlet="bodyColumnTpl[column.id]; context: { $column: column, $item: item }">
            <div [innerHTML]="item[column.id]"></div>
          </ng-container>
          <ng-container *ngIf="!j && rowIconActions.length > 0">
            <ng-container *ngTemplateOutlet="buttonsTpl; context: { actions: rowIconActions, hiddenBorder: true }"></ng-container>
          </ng-container>
        </ng-container>
      </ng-container>
    </li>
  </ng-container>
</ng-template>

<ng-template #buttonsTpl let-space="space" let-hiddenBorder="hiddenBorder" let-actions="actions">
  <x-buttons [space]="space" [hidden-border]="hiddenBorder">
    <x-button
      *ngFor="let action of actions"
      [icon]="action.icon"
      [type]="action.type ? action.type : 'initial'"
      [title]="action.title ? action.title : action.label ? action.label : ''"
      [activated]="action.activated"
      (click)="actionEmit(action, $event)"
      >{{ action.label }}</x-button
    >
  </x-buttons>
</ng-template>
